name: deploy

on:
  workflow_dispatch:
    inputs:
      env:
        description: "배포 환경"
        required: true
        type: string
      image:
        description: "배포할 이미지"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 소스 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # 입력값 검증
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          DEPLOY_ENV="${{ inputs.env }}"
          if [[ "${DEPLOY_ENV}" != "dev" && "${DEPLOY_ENV}" != "prod" ]]; then
            echo "Invalid env: ${DEPLOY_ENV} (allowed: dev, prod)"
            exit 1
          fi

          if [[ -z "${{ inputs.image }}" ]]; then
            echo "Empty image"
            exit 1
          fi

      # SSH 세팅
      - name: Setup SSH
        shell: bash
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -euo pipefail

          mkdir -p ~/.ssh
          echo "${SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          ssh-keyscan -p "${SSH_PORT}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts

      # 서버에 인프라 파일 동기화
      - name: Sync app/platform to server (rsync --delete)
        shell: bash
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          set -euo pipefail

          REMOTE_DIR="/home/epsilon/infra"

          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" "mkdir -p ${REMOTE_DIR}/app ${REMOTE_DIR}/platform"

          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" "command -v rsync >/dev/null 2>&1 || { echo 'rsync not found on server'; exit 1; }"

          rsync -az --delete \
            -e "ssh -p ${SSH_PORT}" \
            "./app/" \
            "${SSH_USER}@${SSH_HOST}:${REMOTE_DIR}/app/"

          rsync -az --delete \
            -e "ssh -p ${SSH_PORT}" \
            "./platform/" \
            "${SSH_USER}@${SSH_HOST}:${REMOTE_DIR}/platform/"

      - name: Deploy on server (compose + swarm)
        shell: bash
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}

          DEPLOY_ENV: ${{ inputs.env }}
          IMAGE: ${{ inputs.image }}

          GHCR_USER: ${{ secrets.GHCR_USER }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          FCM_SA_PATH: ${{ secrets.FCM_SA_PATH }}
        run: |
          set -euo pipefail

          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" bash -lc "
            set -euo pipefail

            DEPLOY_ENV='${DEPLOY_ENV}'
            IMAGE='${IMAGE}'
            REMOTE_DIR='/home/epsilon/infra'
            ENV_FILE='/home/epsilon/env/.env.'\"\${DEPLOY_ENV}\"

            if [[ ! -f \"\${ENV_FILE}\" ]]; then
              echo \"Env file not found: \${ENV_FILE}\"
              exit 1
            fi

            set -a
            source \"\${ENV_FILE}\"
            set +a

            SECRET_NAME='firebase_sa'
            SECRET_FILE='${FCM_SA_PATH}'

            if [[ ! -f \"\${SECRET_FILE}\" ]]; then
              echo \"FCM service account json not found\"
              exit 1
            fi

            # secret 존재 여부 확인 후 없으면 생성
            docker secret inspect \"\${SECRET_NAME}\" >/dev/null 2>&1 || \
              docker secret create \"\${SECRET_NAME}\" \"\${SECRET_FILE}\"

            echo '${GHCR_PAT}' | docker login ghcr.io -u '${GHCR_USER}' --password-stdin

            CONF_SRC=\"\${REMOTE_DIR}/platform/nginx/conf.d/\${DEPLOY_ENV}.conf\"
            CONF_DST=\"\${REMOTE_DIR}/platform/nginx/conf.d/app.conf\"

            if [[ ! -f \"\${CONF_SRC}\" ]]; then
              echo \"Nginx conf not found: \${CONF_SRC}\"
              exit 1
            fi

            cp \"\${CONF_SRC}\" \"\${CONF_DST}\"

            COMPOSE_FILE=\"\${REMOTE_DIR}/platform/docker-compose-platform.\${DEPLOY_ENV}.yml\"
            if [[ ! -f \"\${COMPOSE_FILE}\" ]]; then
              echo \"Compose file not found: \${COMPOSE_FILE}\"
              exit 1
            fi

            docker compose -p platform-\${DEPLOY_ENV} --env-file \"\${ENV_FILE}\" -f \"\${COMPOSE_FILE}\" up -d

            docker compose -p platform-\${DEPLOY_ENV} --env-file \"\${ENV_FILE}\" -f \"\${COMPOSE_FILE}\" exec -T nginx nginx -t
            docker compose -p platform-\${DEPLOY_ENV} --env-file \"\${ENV_FILE}\" -f \"\${COMPOSE_FILE}\" exec -T nginx nginx -s reload

            STACK_FILE=\"\${REMOTE_DIR}/app/stack-backend.yml\"
            if [[ ! -f \"\${STACK_FILE}\" ]]; then
              echo \"Stack file not found: \${STACK_FILE}\"
              exit 1
            fi

            export IMAGE
            docker stack deploy --with-registry-auth -c \"\${STACK_FILE}\" \"\${DEPLOY_ENV}\"
            docker service ps \"\${DEPLOY_ENV}_backend\"
          "
