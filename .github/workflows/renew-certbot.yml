name: renew-certbot

on:
  schedule:
    # 04:00 KST (UTC 19:00 previous day)
    - cron: "0 19 * * *"
  workflow_dispatch:

jobs:
  renew:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        shell: bash
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -euo pipefail

          mkdir -p ~/.ssh
          echo "${SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          ssh-keyscan -p "${SSH_PORT}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts

      - name: Sync platform to server (rsync --delete)
        shell: bash
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          set -euo pipefail

          REMOTE_DIR="/home/epsilon/infra"

          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" "mkdir -p ${REMOTE_DIR}/platform"
          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" "command -v rsync >/dev/null 2>&1 || { echo 'rsync not found on server'; exit 1; }"

          rsync -az --delete \
            -e "ssh -p ${SSH_PORT}" \
            --exclude "certbot/" \
            "./platform/" \
            "${SSH_USER}@${SSH_HOST}:${REMOTE_DIR}/platform/"

      - name: Renew certbot (dev)
        shell: bash
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          set -euo pipefail

          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" bash -s <<'REMOTE'
          set -euo pipefail

          DEPLOY_ENV="dev"
          REMOTE_DIR="/home/epsilon/infra"
          PLATFORM_DIR="${REMOTE_DIR}/platform"
          ENV_FILE="/home/epsilon/env/.env.${DEPLOY_ENV}"
          COMPOSE_FILE="${PLATFORM_DIR}/docker-compose-platform.${DEPLOY_ENV}.yml"
          PROJECT_NAME="platform-${DEPLOY_ENV}"
          MIGRATE_SCRIPT="${PLATFORM_DIR}/scripts/migrate-certbot-volumes.sh"
          CONF_SRC="${PLATFORM_DIR}/nginx/conf.d/${DEPLOY_ENV}.conf"
          CONF_DST="${PLATFORM_DIR}/nginx/conf.d/app.conf"

          if [[ ! -f "${ENV_FILE}" ]]; then
            echo "Env file not found: ${ENV_FILE}"
            exit 1
          fi

          if [[ ! -f "${COMPOSE_FILE}" ]]; then
            echo "Compose file not found: ${COMPOSE_FILE}"
            exit 1
          fi

          if [[ ! -f "${MIGRATE_SCRIPT}" ]]; then
            echo "Migration script not found: ${MIGRATE_SCRIPT}"
            exit 1
          fi

          if [[ ! -f "${CONF_SRC}" ]]; then
            echo "Nginx conf not found: ${CONF_SRC}"
            exit 1
          fi

          set -a
          # shellcheck disable=SC1090
          source "${ENV_FILE}"
          set +a

          : "${PLATFORM_NET_NAME:?PLATFORM_NET_NAME is required}"
          : "${CERTBOT_DOMAIN:?CERTBOT_DOMAIN is required in ${ENV_FILE}}"
          : "${CERTBOT_EMAIL:?CERTBOT_EMAIL is required in ${ENV_FILE}}"

          if docker network inspect "${PLATFORM_NET_NAME}" >/dev/null 2>&1; then
            driver="$(docker network inspect -f '{{.Driver}}' "${PLATFORM_NET_NAME}")"
            attachable="$(docker network inspect -f '{{.Attachable}}' "${PLATFORM_NET_NAME}")"
            if [[ "${driver}" != "overlay" || "${attachable}" != "true" ]]; then
              echo "Network ${PLATFORM_NET_NAME} must be overlay + attachable (driver=${driver}, attachable=${attachable})"
              exit 1
            fi
          else
            swarm_state="$(docker info --format '{{.Swarm.LocalNodeState}}')"
            if [[ "${swarm_state}" != "active" ]]; then
              echo "Network ${PLATFORM_NET_NAME} not found and swarm is not active (state=${swarm_state})"
              exit 1
            fi
            docker network create --driver overlay --attachable "${PLATFORM_NET_NAME}"
          fi

          chmod +x "${MIGRATE_SCRIPT}"
          PROJECT_NAME="${PROJECT_NAME}" COMPOSE_FILE="${COMPOSE_FILE}" ENV_FILE="${ENV_FILE}" "${MIGRATE_SCRIPT}"

          cp "${CONF_SRC}" "${CONF_DST}"
          docker compose -p "${PROJECT_NAME}" --env-file "${ENV_FILE}" -f "${COMPOSE_FILE}" up -d nginx

          if docker compose -p "${PROJECT_NAME}" --env-file "${ENV_FILE}" -f "${COMPOSE_FILE}" \
            run --rm -T --no-deps --entrypoint sh certbot \
            -eu -c '
              domain="$1"
              test -s "/etc/letsencrypt/live/${domain}/fullchain.pem"
              test -s "/etc/letsencrypt/live/${domain}/privkey.pem"
            ' sh "${CERTBOT_DOMAIN}"; then
            echo "Existing certificate found. Running renew."
            docker compose -p "${PROJECT_NAME}" --env-file "${ENV_FILE}" -f "${COMPOSE_FILE}" \
              run --rm -T --no-deps certbot \
              renew --webroot -w /var/www/certbot
          else
            echo "No certificate found. Bootstrapping certificate with certonly."
            docker compose -p "${PROJECT_NAME}" --env-file "${ENV_FILE}" -f "${COMPOSE_FILE}" \
              run --rm -T --no-deps certbot \
              certonly --webroot -w /var/www/certbot \
              -d "${CERTBOT_DOMAIN}" \
              --email "${CERTBOT_EMAIL}" \
              --agree-tos \
              --no-eff-email
          fi

          docker compose -p "${PROJECT_NAME}" --env-file "${ENV_FILE}" -f "${COMPOSE_FILE}" exec -T nginx nginx -t
          docker compose -p "${PROJECT_NAME}" --env-file "${ENV_FILE}" -f "${COMPOSE_FILE}" exec -T nginx nginx -s reload
          docker compose -p "${PROJECT_NAME}" --env-file "${ENV_FILE}" -f "${COMPOSE_FILE}" ps
          REMOTE
